<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perpustakaan Digital</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap");

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
        color: #333;
      }

      header {
        background: linear-gradient(
            rgba(30, 144, 255, 0.8),
            rgba(255, 165, 0, 0.8)
          ),
          url("https://png.pngtree.com/background/20230527/original/pngtree-an-old-bookcase-in-a-library-picture-image_2760144.jpg");
        background-size: cover;
        background-position: center;
        color: white;
        text-align: center;
        padding: 100px 20px;
        margin-bottom: 40px;
      }

      header h1 {
        font-size: 3.5rem;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }
      header p {
        font-size: 1.3rem;
        margin-top: 10px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      h2 {
        color: #1e90ff;
        border-bottom: 3px solid #ffa500;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      .filter-group {
        margin-bottom: 30px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .filter-group input {
        padding: 12px;
        border: 1px solid #1e90ff;
        border-radius: 8px;
        width: 250px;
        font-size: 1rem;
      }

      .filter-group button {
        padding: 12px 30px;
        background-color: #ffa500;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .filter-group button:hover {
        background-color: #ff8c00;
      }

      #booksGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
      }

      .book-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s, box-shadow 0.3s;
      }

      .book-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      }

      .book-cover {
        height: 350px;
        overflow: hidden;
      }

      .book-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .book-info {
        padding: 20px;
      }

      .book-info h3 {
        margin: 0 0 10px;
        color: #1e90ff;
        font-size: 1.3rem;
      }

      .book-info p {
        margin: 8px 0;
        font-size: 0.95rem;
        color: #555;
      }

      .stock-info {
        margin: 15px 0;
        font-weight: 600;
        color: #2e7d32;
      }

      .stock-low {
        color: #c62828 !important;
      }

      .borrow-btn {
        width: 100%;
        padding: 12px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
      }

      .borrow-btn:hover:not(:disabled) {
        background: #45a049;
      }
      .borrow-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #popularCatalog {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .category-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .category-card h3 {
        color: #ffa500;
        margin-top: 0;
      }

      @media (max-width: 768px) {
        header h1 {
          font-size: 2.5rem;
        }
        .filter-group input {
          width: 100%;
        }
        #booksGrid {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 480px) {
        #booksGrid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="navbar-container"></div>

    <header>
      <h1>Perpustakaan Digital</h1>
      <p>Temukan dan pinjam buku favorit Anda dengan mudah</p>
    </header>

    <div class="container">
      <section>
        <h2>Buku Pilihan</h2>
        <div class="filter-group">
          <input
            type="text"
            id="filterCategory"
            placeholder="Filter berdasarkan Kategori"
          />
          <input
            type="text"
            id="filterAuthor"
            placeholder="Filter berdasarkan Penulis"
          />
          <button onclick="filterBooks()">Cari Buku</button>
        </div>

        <div id="booksGrid" class="row"></div>
      </section>

      <section>
        <h2>Katalog Buku Sering Dipinjam</h2>
        <div id="popularCatalog"></div>
      </section>
    </div>

    <!-- Modal Pinjam Buku -->
    <div
      class="modal fade"
      id="borrowModal"
      tabindex="-1"
      aria-labelledby="borrowModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="borrowModalLabel">
              Konfirmasi Peminjaman Buku
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4">
                <img
                  id="modalImage"
                  src=""
                  class="img-fluid rounded"
                  alt="Cover Buku"
                  style="max-height: 350px"
                />
              </div>
              <div class="col-md-8">
                <h4 id="modalTitle"></h4>
                <p><strong>Penulis:</strong> <span id="modalAuthor"></span></p>
                <p>
                  <strong>Kategori:</strong> <span id="modalCategory"></span>
                </p>
                <p>
                  <strong>Stok tersedia:</strong> <span id="modalStock"></span>
                </p>

                <div class="form-check mt-4">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="agreeRules"
                    required
                  />
                  <label
                    class="form-check-label"
                    name="follow_instruct"
                    for="agreeRules"
                  >
                    Saya setuju untuk menjaga buku dengan baik dan mengikuti
                    peraturan perpustakaan
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Batal
            </button>
            <button type="button" class="btn btn-success" id="confirmBorrow">
              Pinjam Buku
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentBookId = null;

      // Buka modal dengan data buku
      function openBorrowModal(book) {
        currentBookId = book._id;
        document.getElementById("modalTitle").textContent = book.title;
        document.getElementById("modalAuthor").textContent = book.author;
        document.getElementById("modalCategory").textContent = book.category;
        document.getElementById("modalStock").textContent = book.stock;
        document.getElementById("modalImage").src =
          book.imageUrl || "https://via.placeholder.com/300x450?text=No+Cover";

        const modal = new bootstrap.Modal(
          document.getElementById("borrowModal")
        );
        modal.show();
      }

      // Konfirmasi pinjam
      document
        .getElementById("confirmBorrow")
        .addEventListener("click", async () => {
          const agreeEl = document.getElementById("agreeRules");
          const labelText = document
            .querySelector('label[for="agreeRules"]')
            .textContent.trim();
          const follow_instruct = agreeEl.checked;

          if (!document.getElementById("agreeRules").checked) {
            alert("Harap centang pernyataan peraturan terlebih dahulu!");
            return;
          }

          const token = localStorage.getItem("token");
          if (!token) {
            alert("Anda harus login terlebih dahulu!");
            window.location.href = "/login";
            return;
          }

          try {
            const response = await fetch("/api/books/borrow", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                bookId: currentBookId,
                follow_instruct, // kirim boolean
                follow_instruct_text: labelText,
              }),
            });

            const data = await response.json();
            alert(data.message);

            if (response.ok) {
              bootstrap.Modal.getInstance(
                document.getElementById("borrowModal")
              ).hide();
              loadBooks(); // Refresh daftar
            }
          } catch (err) {
            alert("Gagal meminjam buku. Silakan coba lagi.");
          }
        });

      async function loadBooks(url = "/api/books") {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Gagal mengambil data");
          const books = await response.json();

          const grid = document.getElementById("booksGrid");
          grid.innerHTML = "";

          if (books.length === 0) {
            grid.innerHTML =
              "<p class='col-12 text-center text-muted'>Tidak ada buku yang ditemukan.</p>";
            return;
          }

          books.forEach((book) => {
            const col = document.createElement("div");
            col.className = "col";

            const card = document.createElement("div");
            card.className = "book-card";

            const stockClass = book.stock <= 0 ? "stock-low" : "";
            const stockText =
              book.stock > 0 ? `Tersedia: ${book.stock}` : "Stok Habis";

            card.innerHTML = `
            <div class="book-cover">
              <img src="${
                book.imageUrl ||
                "https://via.placeholder.com/300x450?text=No+Cover"
              }" alt="${book.title}">
            </div>
            <div class="book-info">
              <h3>${book.title}</h3>
              <p><strong>Penulis:</strong> ${book.author}</p>
              <p><strong>Kategori:</strong> ${book.category}</p>
              <div class="stock-info ${stockClass}">${stockText}</div>
              <button class="borrow-btn" onclick='openBorrowModal(${JSON.stringify(
                book
              )})' ${book.stock <= 0 ? "disabled" : ""}>
                ${book.stock > 0 ? "Pinjam Buku" : "Stok Habis"}
              </button>
            </div>
          `;

            col.appendChild(card);
            grid.appendChild(col);
          });
        } catch (err) {
          console.error(err);
          document.getElementById("booksGrid").innerHTML =
            "<p class='text-danger'>Gagal memuat buku.</p>";
        }
      }

      function filterBooks() {
        const category = document.getElementById("filterCategory").value.trim();
        const author = document.getElementById("filterAuthor").value.trim();
        let url = "/api/books/filter?";
        if (category) url += `category=${encodeURIComponent(category)}&`;
        if (author) url += `author=${encodeURIComponent(author)}`;
        if (url.endsWith("&") || url.endsWith("?")) url = url.slice(0, -1);
        loadBooks(url || "/api/books");
      }

      async function loadPopular() {
        try {
          const response = await fetch("/api/popular-books");
          if (!response.ok) throw new Error("Gagal catalog");
          const categories = await response.json();
          const catalogDiv = document.getElementById("popularCatalog");
          catalogDiv.innerHTML = "";
          categories.forEach((cat) => {
            const card = document.createElement("div");
            card.className = "category-card";
            let list = "";
            cat.books.forEach((book) => {
              list += `<li><strong>${book.title}</strong> â€” ${book.author} (${
                book.borrowCount || 0
              } kali dipinjam)</li>`;
            });
            card.innerHTML = `<h3>${cat._id || "Umum"}</h3><ul>${
              list || "<li>Belum ada data</li>"
            }</ul>`;
            catalogDiv.appendChild(card);
          });
        } catch (err) {
          console.error(err);
        }
      }

      window.onload = () => {
        loadBooks();
        loadPopular();
      };
    </script>
    <script>
      // Load navbar.html dulu
      fetch("/components/navbar.html")
        .then((response) => {
          if (!response.ok) throw new Error("Gagal load navbar");
          return response.text();
        })
        .then((html) => {
          document.getElementById("navbar-container").innerHTML = html;

          const script = document.createElement("script");
          script.src = "/js/auth-frontend.js";
          script.onload = () => {
            console.log("Navbar & Auth System berhasil dimuat");
            if (typeof updateNavbar === "function") updateNavbar();
          };
          script.onerror = () => console.error("Gagal load auth-frontend.js");
          document.body.appendChild(script);
        })
        .catch((err) => console.error(err));
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
  </body>
</html>
